<apex:page controller="NVMContactWorld.LogViewerController"  standardStylesheets="false" renderAs="{!renderAs}" action="{!refresh}" showHeader="{!showHeader}">
	<apex:outputText rendered="{renderAs == 'PDF'}">
	@page {
		/* Landscape orientation */
		size:landscape;
		
		margin:3%;
		
		@top-left {
			content: "Dialler Logs";
			  }
		@top-right {
			content: "Page " counter(page);
		}
	}
	</apex:outputText>

	<apex:pageMessages />

	<script>
		function colorPageBlock(pageblock, color) {
			if (pageblock != null) pageblock.firstChild.style.cssText = "background-color: " + color + ";";
		}
	</script>

	<a id="top"/>

	<apex:stylesheet value="{!URLFOR($Resource.NVMContactWorld__logViewerCss)}"/>
	
	<apex:form id="mainForm" style="width:100%;font-size:100%">

		<apex:outputPanel rendered="{!renderAs == 'PDF'}">
			Dialler Logs from&nbsp;<apex:outputText value="{!startHour}"/>:<apex:outputText value="{!startMinute}"/> to&nbsp;
			<apex:outputText value="{!endHour}"/>:<apex:outputText value="{!endMinute}"/> generated by {!$User.FirstName} {!$User.LastName}
			for {!$Organization.Name} [{!$Organization.Country}, {!$Organization.Id}]
		</apex:outputPanel>
		
		<apex:toolbar id="logViewerToolbar" styleClass="logViewerHeader" rendered="{!renderAs != 'PDF'}">
			<apex:outputPanel >
			Date:
		  	<apex:inputField value="{!proxy.ActivityDate}" />
			From:
			<apex:selectList value="{!startHour}" size="1">
				<apex:selectOptions value="{!hours}" />
			</apex:selectList>
			:
			<apex:selectList value="{!startMinute}" size="1">
				<apex:selectOptions value="{!mins}" />
			</apex:selectList>
			To:
			<apex:selectList value="{!endHour}" size="1">
				<apex:selectOptions value="{!hours}" />
			</apex:selectList>
			:
			<apex:selectList value="{!endMinute}" size="1">
				<apex:selectOptions value="{!mins}" />
			</apex:selectList>      
          </apex:outputPanel>

          <apex:outputPanel >
		  	Logs
			<apex:inputCheckbox value="{!showLogs}" label="Show Logs" />
			Limits
			<apex:inputCheckbox value="{!showLimits}" />
			<apex:commandButton value="Refresh" action="{!refresh}" />
		  
			<apex:commandLink value="Get PDF" action="{!toPDF}" target="_blank"/>
		  
			<apex:commandButton rendered="{!showLogs == TRUE && numLogs > 0}" value="Delete Logs" action="{!deleteLogs}" />
          </apex:outputPanel>
		  
		</apex:toolbar>

		<apex:outputPanel rendered="{!showLimits == TRUE && renderAs != 'PDF'}">
		<a href="#limits">Limits Section</a>
		</apex:outputPanel>
		<apex:outputPanel rendered="{!showLogs == TRUE && showLimits == TRUE && renderAs != 'PDF'}">
		<a href="#endoflogs">End of Logs</a>
		</apex:outputPanel>
		<a href="#end">Jump to End</a>

		<apex:pageBlock rendered="{!showLogs == TRUE && renderAs != 'PDF'}" title="Logs">

			<apex:repeat value="{!logFiles}" var="log">

				<apex:pageBlockSection id="section" title="{!log.logTask.Subject}">

					<apex:pageBlockTable style="width:850px;font-size:80%"
						columnsWidth="50px, 110px, 40px, 650px" value="{!log.logs}"
						var="item" border="1" columns="4">
						<apex:column rendered="{!item.isError == FALSE}" headerValue="+ms"
							value="{!item.offset}" />
						<apex:column rendered="{!item.isError == FALSE}"
							headerValue="User" value="{!item.user}" />
						<apex:column rendered="{!item.isError == FALSE}"
							headerValue="Error" value="{!item.isError}" />
						<apex:column rendered="{!item.isError == FALSE}" headerValue="Log"
							style="width:650px;max-width:650px;overflow:auto"
							value="{!item.message}" />

						<apex:column rendered="{!item.isError}" style="color:red"
							headerValue="+ms" value="{!item.offset}" />
						<apex:column rendered="{!item.isError}" style="color:red"
							headerValue="User" value="{!item.user}" />
						<apex:column rendered="{!item.isError}" style="color:red"
							headerValue="Error" value="{!item.isError}" />
						<apex:column rendered="{!item.isError}" headerValue="Log"
							style="color:red;width:650px;max-width:650px;overflow:auto"
							value="{!item.message}" />


					</apex:pageBlockTable>
				</apex:pageBlockSection>

				<script>colorPageBlock(document.getElementById("{!$Component.section}"), "{!log.colour}");</script>

			</apex:repeat>
		</apex:pageBlock>

		<apex:outputPanel rendered="{!showLogs == TRUE && renderAs == 'PDF'}" title="Logs">

			<apex:repeat value="{!logFiles}" var="log">
				<div><br/>
				<apex:outputText style="12px Helvetica" value="{!log.logTask.Subject}"/>

					<table style="width:100px; word-wrap:break-word;border-collapse:collapse;table-layout:fixed;width:650px;border:solid 1px">
						<tr><td style="font-size:80%;width:50px;word-wrap:break-word;border:solid 1px"><b>+ms</b></td>
						<td style="font-size:80%;width:110px;word-wrap:break-word;border:solid 1px"><b>User</b></td>
						<td style="font-size:80%;width:40px;word-wrap:break-word;border:solid 1px"><b>Error</b></td>
						<td style="font-size:80%;width:450px;word-wrap:break-word;border:solid 1px"><b>Log</b></td></tr>
						<apex:repeat value="{!log.logs}" var="item">
						<tr>
						<td style="font-size:80%;width:50px;word-wrap:break-word;border:solid 1px">
						<apex:outputText rendered="{!item.isError == FALSE}" style="font-size:80%" value="{!item.offset}" />
						<apex:outputText rendered="{!item.isError}" style="font-size:80%;color:red" value="{!item.offset}" />
						</td>
						<td style="font-size:80%;width:110px;word-wrap:break-word;border:solid 1px">
						<apex:outputText rendered="{!item.isError == FALSE}" style="font-size:80%" value="{!item.user}" />
						<apex:outputText rendered="{!item.isError}" style="font-size:80%;color:red" value="{!item.user}" />
						</td>
						<td style="font-size:80%;width:40px;word-wrap:break-word;border:solid 1px">
						<apex:outputText rendered="{!item.isError == FALSE}" style="font-size:80%" value="{!item.isError}" />
						<apex:outputText rendered="{!item.isError}" style="font-size:80%;color:red" value="{!item.isError}" />
						</td>
						<td style="font-size:80%;width:450px;word-wrap:break-word;border:solid 1px">
						<apex:outputText style="font-size:80%;width:450px;word-wrap:break-word;border-collapse:collapse;" rendered="{!item.isError == FALSE}" value="{!item.message}" />
						<apex:outputText style="font-size:80%;width:450px;word-wrap:break-word;border-collapse:collapse;color:red" rendered="{!item.isError}" value="{!item.message}" />
						</td>
						</tr>
						</apex:repeat>
					</table>
				</div>

				<script>colorPageBlock(document.getElementById("{!$Component.section}"), "{!log.colour}");</script>

			</apex:repeat>
		</apex:outputPanel>


		<a name="endoflogs" id="endoflogs"/>

		<a name="limits" id="limits"/>
		<apex:pageBlock rendered="{!showLimits == TRUE && renderAs != 'PDF'}"
			title="Governor Limits">
			
			<apex:repeat value="{!logFiles}" var="log">

				<apex:panelGrid cellspacing="20" columns="1" width="850px"
					id="barGrid" style="font-size:100%">
					<apex:chart animate="false" width="800" height="300"
						data="{!log.limitsList}">
						<apex:axis type="Numeric" position="left" minimum="0"
							maximum="100" fields="value" title="Percent" grid="true" />
						<apex:axis type="Category" position="bottom" fields="metric"
							title="{!log.logTask.Subject}">
							<apex:chartLabel font="9px Helvetica" rotate="270" />
						</apex:axis>
						<apex:barSeries title="{!log.logTask.Subject}"
							colorsProgressWithinSeries="true" orientation="vertical"
							axis="left" stacked="false" xField="metric" yField="value">
							<apex:chartTips height="20" width="120" />
						</apex:barSeries>
					</apex:chart>
				</apex:panelGrid>
			</apex:repeat>
		</apex:pageBlock>

		<a href="#top">Top</a>
		<a name="end" id="end"/>

	</apex:form>
</apex:page>